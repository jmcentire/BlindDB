<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Blind Database — Interactive Demo</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0d1117; color: #c9d1d9; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    #app { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { text-align: center; padding: 20px 0 12px; }
    header h1 { font-size: 26px; color: #f0f6fc; letter-spacing: 0.5px; }
    header .subtitle { color: #8b949e; font-size: 14px; margin-top: 4px; }
    header .subtitle em { color: #c9d1d9; }

    #phase-bar { display: flex; justify-content: center; gap: 32px; padding: 10px 0; }
    .phase-label { padding: 5px 16px; border-radius: 16px; font-size: 13px; font-weight: 600; letter-spacing: 0.5px; transition: all 0.3s; }
    .phase-label.active-today { background: #da3633; color: #fff; }
    .phase-label.active-tomorrow { background: #238636; color: #fff; }
    .phase-label.inactive { color: #484f58; background: transparent; }

    #step-bar { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 6px 0 14px; }
    #step-name { font-size: 14px; color: #8b949e; }
    #step-dots { display: flex; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #21262d; transition: background 0.2s; }
    .dot.active { background: #58a6ff; }
    .dot.done { background: #3fb950; }

    #panels { display: grid; grid-template-columns: 1fr 90px 1fr; gap: 0; min-height: 380px; }
    #panels.hidden { display: none; }
    .panel { background: #161b22; border: 1px solid #21262d; border-radius: 8px; padding: 16px; overflow-y: auto; max-height: 480px; }
    .panel-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #21262d; }
    #client { border-color: #1f6f2b; }
    #client .panel-title { color: #3fb950; }
    #server { border-color: #1f3d6f; }
    #server .panel-title { color: #58a6ff; }

    #wire { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 36px; position: relative; }
    .wire-line { position: absolute; top: 0; bottom: 0; left: 50%; width: 2px; background: repeating-linear-gradient(to bottom, #21262d 0px, #21262d 5px, transparent 5px, transparent 10px); }
    #wire-body { position: relative; z-index: 1; display: flex; flex-direction: column; gap: 4px; align-items: center; }
    .pkt { font-family: 'SF Mono','Fira Code',monospace; font-size: 10px; padding: 3px 6px; border-radius: 3px; white-space: nowrap; max-width: 84px; overflow: hidden; text-overflow: ellipsis; }
    .pkt.out { background: #d29922; color: #0d1117; }
    .pkt.in { background: #388bfd; color: #fff; }
    .pkt.danger { background: #da3633; color: #fff; }
    .wire-label { font-size: 10px; color: #484f58; text-transform: uppercase; letter-spacing: 1px; }

    #full-view { display: none; background: #161b22; border: 1px solid #21262d; border-radius: 8px; padding: 20px; max-height: 520px; overflow-y: auto; }
    #full-view.active { display: block; }

    #narration { background: #161b22; border: 1px solid #21262d; border-radius: 8px; padding: 14px 18px; margin: 14px 0; min-height: 50px; }
    #narration-text { font-size: 14px; line-height: 1.6; color: #c9d1d9; }
    #narration-text strong { color: #f0f6fc; }

    #nav { display: flex; justify-content: space-between; padding: 4px 0; }
    #nav button { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; border-radius: 6px; padding: 8px 20px; cursor: pointer; font-size: 14px; transition: background 0.15s; }
    #nav button:hover:not(:disabled) { background: #30363d; }
    #nav button:disabled { opacity: 0.3; cursor: not-allowed; }
    #nav button.primary { background: #238636; border-color: #2ea043; color: #fff; }
    #nav button.primary:hover:not(:disabled) { background: #2ea043; }

    .section { margin-bottom: 10px; }
    .label { font-size: 11px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
    .value { font-family: 'SF Mono','Fira Code',monospace; font-size: 13px; color: #f0f6fc; word-break: break-all; }
    .hash { font-family: 'SF Mono','Fira Code',monospace; font-size: 13px; color: #d2a8ff; word-break: break-all; }
    .note { font-size: 12px; color: #484f58; margin-top: 8px; }
    .callout { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 10px; margin-top: 10px; font-size: 12px; color: #8b949e; }
    .callout.warn { border-color: #d29922; color: #d29922; }
    .callout.bad { border-color: #da3633; color: #f85149; }
    .callout.good { border-color: #238636; color: #3fb950; }
    .danger-text { color: #f85149; }
    .safe-text { color: #3fb950; }
    .ceremony-step { font-size: 13px; padding: 4px 0; color: #8b949e; }
    .ceremony-step .chk { color: #3fb950; }

    input[type="text"], textarea {
      background: #0d1117; border: 1px solid #30363d; color: #c9d1d9;
      padding: 8px 12px; border-radius: 6px; font-size: 14px; width: 100%; font-family: inherit;
    }
    input:focus, textarea:focus { outline: none; border-color: #388bfd; }
    textarea { min-height: 60px; resize: vertical; }

    .db-table { width: 100%; border-collapse: collapse; font-family: 'SF Mono','Fira Code',monospace; font-size: 11px; }
    .db-table th { background: #21262d; padding: 6px 8px; text-align: left; border-bottom: 2px solid #30363d; color: #8b949e; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .db-table td { padding: 5px 8px; border-bottom: 1px solid #161b22; }
    .db-table tr:hover { background: rgba(56,139,253,0.05); }
    .db-table .pii { color: #f85149; }
    .db-table .hex { color: #7ee787; }
    .db-table tr.you { background: rgba(218,54,51,0.15); }
    .db-table tr.you td { font-weight: 600; }
    .breach-prompt { font-family: 'SF Mono',monospace; font-size: 13px; color: #d29922; margin-bottom: 12px; }
    .breach-count { margin-top: 16px; font-size: 13px; color: #8b949e; text-align: center; }

    .info-box { padding: 8px 0; }
    .info-box h3 { font-size: 16px; color: #f0f6fc; margin-bottom: 6px; }
    .info-box p { font-size: 13px; line-height: 1.5; margin-bottom: 4px; }
    .info-box .small { font-size: 12px; color: #484f58; margin-top: 8px; }

    .three-hashes { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 12px; }
    .three-hashes .hash-card { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 10px; }
    .three-hashes .hash-card .label { font-size: 10px; }
    .three-hashes .hash-card .hash { font-size: 11px; }
    .three-hashes .hash-card .sub { font-size: 10px; color: #484f58; margin-top: 4px; }

    .comp { font-family: 'SF Mono',monospace; font-size: 12px; color: #8b949e; background: #0d1117; padding: 8px; border-radius: 4px; margin: 4px 0; word-break: break-all; }
    .comp .fn { color: #d2a8ff; }
    .comp .arg { color: #79c0ff; }
    .comp .res { color: #ffa657; }
    .comp .secret { color: #3fb950; text-decoration: underline; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>The Blind Database</h1>
      <p class="subtitle">Interactive demo from <em>The Ephemeral Internet</em> by Jeremy McEntire</p>
    </header>
    <div id="phase-bar">
      <span id="ph-today" class="phase-label inactive">Today</span>
      <span id="ph-tomorrow" class="phase-label inactive">Tomorrow</span>
    </div>
    <div id="step-bar">
      <span id="step-name"></span>
      <div id="step-dots"></div>
    </div>
    <div id="panels">
      <div id="client" class="panel">
        <div class="panel-title">Your Browser</div>
        <div id="client-body"></div>
      </div>
      <div id="wire">
        <div class="wire-line"></div>
        <div id="wire-body"></div>
      </div>
      <div id="server" class="panel">
        <div class="panel-title">The Server</div>
        <div id="server-body"></div>
      </div>
    </div>
    <div id="full-view"></div>
    <div id="narration"><p id="narration-text"></p></div>
    <div id="nav">
      <button id="back-btn" onclick="prev()" disabled>&larr; Back</button>
      <button id="next-btn" onclick="next()" class="primary">Begin</button>
    </div>
  </div>

<script>
// ========== UTILITIES ==========
async function sha256(s) {
  const d = new TextEncoder().encode(s);
  const h = await crypto.subtle.digest('SHA-256', d);
  return Array.from(new Uint8Array(h)).map(b => b.toString(16).padStart(2,'0')).join('');
}
function randomHex(n) {
  const a = new Uint8Array(n); crypto.getRandomValues(a);
  return Array.from(a).map(b => b.toString(16).padStart(2,'0')).join('');
}
function hexToBytes(h) {
  const b = new Uint8Array(h.length/2);
  for (let i=0;i<h.length;i+=2) b[i/2]=parseInt(h.substr(i,2),16);
  return b;
}
function xorCrypt(text, keyHex) {
  const tb = new TextEncoder().encode(text);
  const kb = hexToBytes(keyHex);
  const r = new Uint8Array(tb.length);
  for (let i=0;i<tb.length;i++) r[i]=tb[i]^kb[i%kb.length];
  return Array.from(r).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function xorDecrypt(hexCt, keyHex) {
  const cb = hexToBytes(hexCt), kb = hexToBytes(keyHex);
  const r = new Uint8Array(cb.length);
  for (let i=0;i<cb.length;i++) r[i]=cb[i]^kb[i%kb.length];
  return new TextDecoder().decode(r);
}
function trunc(h, n=10) { return h.length<=n+4 ? h : h.slice(0,n)+'...'+h.slice(-4); }
function $(id) { return document.getElementById(id); }
function setC(h) { $('client-body').innerHTML=h; }
function setW(h) { $('wire-body').innerHTML=h; }
function setS(h) { $('server-body').innerHTML=h; }
function setN(h) { $('narration-text').innerHTML=h; }
function showPanels() { $('panels').classList.remove('hidden'); $('full-view').classList.remove('active'); }
function showFull(h) { $('panels').classList.add('hidden'); $('full-view').classList.add('active'); $('full-view').innerHTML=h; }

// ========== STATE ==========
const S = { username:'', password:'', credHash:'', masterSecret:'', userId:'', userSalt:'', siteToken:'', pohScore:0.42, recordId:'', encKey:'', userMsg:'', encMsg:'' };
const blindDB = [];
const credStore = {};

function seedDB() {
  blindDB.length = 0;
  for (let i=0;i<50;i++) blindDB.push({ id: randomHex(32), val: randomHex(32+Math.floor(Math.random()*48)) });
}

// ========== TODAY FAKE DATA ==========
function todayUsers() {
  return [
    {id:1, u:'jsmith42', email:'john.smith@gmail.com', ph:'(503) 555-0142', name:'John Smith', city:'Portland, OR'},
    {id:2, u:'emily_r', email:'emily.rodriguez@yahoo.com', ph:'(206) 555-0287', name:'Emily Rodriguez', city:'Seattle, WA'},
    {id:3, u:'chen_wei', email:'wei.chen@outlook.com', ph:'(415) 555-0193', name:'Wei Chen', city:'San Francisco, CA'},
    {id:4, u:'sarah_k', email:'sarah.klein@proton.me', ph:'(312) 555-0164', name:'Sarah Klein', city:'Chicago, IL'},
    {id:5, u:'ahmed_m', email:'ahmed.malik@gmail.com', ph:'(646) 555-0218', name:'Ahmed Malik', city:'New York, NY'},
    {id:6, u:'lisa_n', email:'lisa.nguyen@hotmail.com', ph:'(213) 555-0329', name:'Lisa Nguyen', city:'Los Angeles, CA'},
    {id:7, u:'david_p', email:'david.park@gmail.com', ph:'(617) 555-0451', name:'David Park', city:'Boston, MA'},
    {id:8, u:S.username, email:S.username+'@email.com', ph:'(555) 555-0199', name:S.username, city:'Unknown'},
    {id:9, u:'maria_g', email:'maria.garcia@icloud.com', ph:'(305) 555-0573', name:'Maria Garcia', city:'Miami, FL'},
    {id:10, u:'alex_t', email:'alex.turner@gmail.com', ph:'(512) 555-0684', name:'Alex Turner', city:'Austin, TX'},
  ];
}
function todayBrowsing() {
  return [
    {u:'jsmith42', url:'/health/symptoms-of-depression', t:'2024-01-14 23:15'},
    {u:'jsmith42', url:'/jobs/leaving-toxic-workplace', t:'2024-01-15 10:00'},
    {u:'emily_r', url:'/legal/how-to-file-for-divorce', t:'2024-01-15 09:30'},
    {u:'emily_r', url:'/finance/hidden-assets-in-divorce', t:'2024-01-16 01:30'},
    {u:'chen_wei', url:'/finance/bankruptcy-chapter-7-vs-13', t:'2024-01-15 11:45'},
    {u:'sarah_k', url:'/health/early-signs-of-pregnancy', t:'2024-01-14 22:00'},
    {u:'sarah_k', url:'/health/pregnancy-options-counseling', t:'2024-01-15 19:30'},
    {u:'ahmed_m', url:'/immigration/asylum-application-process', t:'2024-01-15 08:20'},
    {u:S.username, url:'/health/is-anxiety-normal', t:'2024-01-15 02:30'},
    {u:S.username, url:'/finance/how-much-debt-is-too-much', t:'2024-01-16 11:15'},
    {u:'lisa_n', url:'/legal/restraining-order-process', t:'2024-01-15 14:00'},
    {u:'alex_t', url:'/health/std-testing-near-me', t:'2024-01-14 20:45'},
    {u:'david_p', url:'/jobs/salary-negotiation-tips', t:'2024-01-15 12:30'},
    {u:'maria_g', url:'/health/domestic-violence-resources', t:'2024-01-16 03:15'},
  ];
}

// ========== STEP DEFINITIONS ==========
const steps = [
  { phase:'setup', name:'Welcome', render:renderWelcome, btn:'Begin', validate:valCreds },
  { phase:'today', name:'The Login Ceremony', render:renderCeremony },
  { phase:'today', name:"The Server's Treasure", render:renderTodayData },
  { phase:'today', name:'The Breach', render:renderTodayBreach, btn:'What if there were another way?' },
  { phase:'tomorrow', name:'The Blind Database', render:renderBlindIntro },
  { phase:'tomorrow', name:'Authentication', render:renderBlindAuth },
  { phase:'tomorrow', name:'Your Identity Here', render:renderBlindToken },
  { phase:'tomorrow', name:'Write a Message', render:renderBlindWrite, btn:'Encrypt & Store', validate:valMsg },
  { phase:'tomorrow', name:'Message Stored', render:renderBlindStored },
  { phase:'tomorrow', name:'Retrieve Your Message', render:renderBlindRetrieve },
  { phase:'tomorrow', name:'The Same Breach', render:renderBlindBreach },
  { phase:'tomorrow', name:'Find Your Data', render:renderInspector, btn:'Start Over' },
];

let cur = 0;

function valCreds() {
  const u=$('input-u'), p=$('input-p');
  if (!u||!u.value||!p||!p.value) { if(u) u.style.borderColor='#da3633'; if(p) p.style.borderColor='#da3633'; return false; }
  S.username=u.value; S.password=p.value;
  return true;
}
function valMsg() {
  const m=$('input-msg');
  if (!m||!m.value) { if(m) m.style.borderColor='#da3633'; return false; }
  S.userMsg=m.value;
  return true;
}

async function next() {
  if (steps[cur].validate && !steps[cur].validate()) return;
  // Pre-compute on leaving certain steps
  if (cur===0) await computeAuth();
  if (cur===7) await computeStore();
  cur++;
  if (cur>=steps.length) { cur=0; seedDB(); }
  await steps[cur].render();
  updateUI();
}
function prev() {
  if (cur<=0) return;
  cur--;
  steps[cur].render();
  updateUI();
}
function updateUI() {
  const s=steps[cur];
  $('ph-today').className='phase-label '+(s.phase==='today'||s.phase==='setup'?'active-today':'inactive');
  $('ph-tomorrow').className='phase-label '+(s.phase==='tomorrow'?'active-tomorrow':'inactive');
  $('step-name').textContent=s.name;
  $('step-dots').innerHTML=steps.map((_,i)=>`<span class="dot${i===cur?' active':i<cur?' done':''}"></span>`).join('');
  $('back-btn').disabled=cur===0;
  $('next-btn').textContent=s.btn||'Next \u2192';
}

async function computeAuth() {
  S.credHash = await sha256(S.username+S.password);
  S.masterSecret = await sha256(S.username+S.password+'master');
  S.userId = randomHex(16);
  S.userSalt = randomHex(16);
  credStore[S.credHash] = { uid:S.userId, salt:S.userSalt };
  S.siteToken = await sha256(S.username+'blind-db-demo'+S.userId+S.userSalt);
}
async function computeStore() {
  S.recordId = await sha256(S.masterSecret+'messages'+'0');
  S.encKey = await sha256(S.masterSecret+S.recordId+'encrypt');
  S.encMsg = xorCrypt(S.userMsg, S.encKey);
  blindDB.splice(Math.floor(Math.random()*blindDB.length), 0, { id:S.recordId, val:S.encMsg });
}

// ========== RENDERERS ==========

function renderWelcome() {
  showPanels();
  setC(`
    <div class="section"><div class="label">Username</div>
      <input type="text" id="input-u" placeholder="anything" autocomplete="off" /></div>
    <div class="section"><div class="label">Password</div>
      <input type="text" id="input-p" placeholder="anything" autocomplete="off" /></div>
    <p class="note">Pick anything. These are just for the demo.</p>
  `);
  setW('<div class="wire-label">network</div>');
  setS(`<div class="info-box">
    <p>We'll show what happens to your credentials in two architectures:</p>
    <p><strong style="color:#da3633">Today</strong> — how it works now.</p>
    <p><strong style="color:#238636">Tomorrow</strong> — with a Blind Database.</p>
  </div>`);
  setN('Enter any username and password. We\'ll show how they\'re handled <strong>today</strong>, then how they <em>could</em> be handled with a <strong>Blind Database</strong>.');
}

function renderCeremony() {
  showPanels();
  setC(`
    <div class="section"><div class="label">Logging in as</div><div class="value">${S.username}</div></div>
    <div class="ceremony-step"><span class="chk">1.</span> Password sent to server</div>
    <div class="ceremony-step"><span class="chk">2.</span> Server sends SMS to your phone</div>
    <div class="ceremony-step"><span class="chk">3.</span> You enter the 6-digit code</div>
    <div class="ceremony-step"><span class="chk">4.</span> CAPTCHA: click the traffic lights</div>
    <div class="ceremony-step"><span class="chk">5.</span> "Accept all cookies"</div>
    <div class="ceremony-step"><span class="chk">6.</span> "I agree to the privacy policy"</div>
    <div class="ceremony-step"><span class="chk">7.</span> "We noticed a new device. Was this you?"</div>
    <div class="ceremony-step"><span class="chk">8.</span> Session established</div>
  `);
  setW(`
    <div class="pkt out">${S.password}</div>
    <div class="pkt in">SMS sent</div>
    <div class="pkt out">847291</div>
    <div class="pkt in">CAPTCHA</div>
    <div class="pkt out">lights</div>
    <div class="pkt in">cookies?</div>
    <div class="pkt out">accept</div>
    <div class="pkt in">terms?</div>
    <div class="pkt out">I agree</div>
    <div class="pkt in">new dev?</div>
    <div class="pkt out">yes, me</div>
    <div class="pkt in">SESSION</div>
  `);
  setS(`
    <div class="section"><div class="label">Server now holds</div>
      <div class="value danger-text">Password hash: $2b$12$K3x...</div>
      <div class="value danger-text">Phone: (555) 555-0199</div>
      <div class="value danger-text">Email: ${S.username}@email.com</div>
      <div class="value danger-text">IP: 203.0.113.42</div>
      <div class="value danger-text">Device: Chrome / macOS</div>
      <div class="value danger-text">Cookies: tracking=yes</div>
    </div>
    <div class="callout warn">Twelve wire exchanges to establish a session. The session is well-protected. The data behind it is not.</div>
  `);
  setN('Twelve exchanges. Your password, a one-time code, a CAPTCHA, cookie consent, a privacy policy, a device check. All to protect <strong>the session</strong>. But what about the data behind it?');
}

function renderTodayData() {
  showPanels();
  setC(`<div class="info-box"><p>You browse. You message. You search.</p><p>The server records everything.</p></div>`);
  setW(`
    <div class="pkt out">view pg</div>
    <div class="pkt out">search</div>
    <div class="pkt out">message</div>
    <div class="pkt out">click</div>
    <div class="pkt out">view pg</div>
  `);
  const users = todayUsers();
  setS(`
    <div class="section"><div class="label">users table</div></div>
    <table class="db-table"><thead><tr><th>id</th><th>username</th><th>email</th><th>phone</th><th>city</th></tr></thead>
    <tbody>${users.map(u=>`<tr class="${u.u===S.username?'you':''}"><td>${u.id}</td><td class="pii">${u.u}</td><td class="pii">${u.email}</td><td class="pii">${u.ph}</td><td class="pii">${u.city}</td></tr>`).join('')}</tbody></table>
    <div class="callout bad">Every field readable. Every query answered. "Encrypted at rest" protects the hard drive from physical theft. It does not protect this data from the application, the admin, or the attacker.</div>
  `);
  setN('Here is the server\'s <code>users</code> table. Usernames, emails, phone numbers, cities. All in plaintext. The "encryption at rest" protects the disk. <strong>Any application query reads the plaintext directly.</strong>');
}

function renderTodayBreach() {
  const users = todayUsers();
  const browsing = todayBrowsing();
  showFull(`
    <div class="breach-prompt">&gt; SELECT * FROM users;</div>
    <table class="db-table"><thead><tr><th>id</th><th>username</th><th>email</th><th>phone</th><th>name</th><th>city</th></tr></thead>
    <tbody>${users.map(u=>`<tr class="${u.u===S.username?'you':''}"><td>${u.id}</td><td class="pii">${u.u}</td><td class="pii">${u.email}</td><td class="pii">${u.ph}</td><td class="pii">${u.name}</td><td class="pii">${u.city}</td></tr>`).join('')}</tbody></table>
    <div class="breach-prompt" style="margin-top:20px">&gt; SELECT * FROM browsing_history;</div>
    <table class="db-table"><thead><tr><th>user</th><th>url</th><th>time</th></tr></thead>
    <tbody>${browsing.map(b=>`<tr class="${b.u===S.username?'you':''}"><td class="pii">${b.u}</td><td class="pii">${b.url}</td><td>${b.t}</td></tr>`).join('')}</tbody></table>
    <div class="breach-count">10 users. 14 browsing records. Names, emails, phones, and every page they visited — in plaintext.<br>
    <span class="danger-text">Your rows are highlighted.</span></div>
  `);
  setN('One SQL injection. Every user\'s data. John searches for depression symptoms at midnight. Emily researches divorce. Sarah looks up pregnancy signs. Ahmed reads about asylum. Maria looks for domestic violence resources. <strong>The MFA, the CAPTCHA, the cookie consent — none of it protected this data.</strong> Those ceremonies protected the session. Nobody came through the session.');
}

function renderBlindIntro() {
  showPanels();
  setC(`<div class="info-box">
    <h3>Same user. Same data.</h3>
    <p>You are still <strong>${S.username}</strong>.</p>
    <p>Same password. Same messages. Same browsing.</p>
    <p>Different architecture.</p>
  </div>`);
  setW('<div class="wire-label">network</div>');
  setS(`<div class="info-box">
    <h3>A Blind Database</h3>
    <p>This server stores data it <strong>cannot read</strong>, for users it <strong>cannot identify</strong>.</p>
    <p>Not "will not." <strong>Cannot.</strong></p>
    <p>The math does not allow it.</p>
    <p class="small">${blindDB.length} opaque records currently stored.</p>
  </div>`);
  setN('Same scenario. Same credentials. Different architecture. In a Blind Database, the server stores encrypted blobs at opaque addresses. It holds nothing it can read, for no user it can name.');
}

function renderBlindAuth() {
  showPanels();
  setC(`
    <div class="section"><div class="label">Your credentials (never sent)</div>
      <div class="value"><span class="secret">${S.username}</span> / <span class="secret">${S.password}</span></div></div>
    <div class="section"><div class="label">Step 1: Hash locally</div>
      <div class="comp"><span class="fn">SHA-256</span>(<span class="arg">"${S.username}" + "${S.password}"</span>)</div>
      <div class="comp">= <span class="res">${trunc(S.credHash,20)}</span></div></div>
    <div class="section"><div class="label">Step 2: Receive from server</div>
      <div class="value">user_id: ${trunc(S.userId)}</div>
      <div class="value">user_salt: ${trunc(S.userSalt)}</div></div>
    <div class="callout good">Your username and password never left the browser. The server matched a hash to an ID. It does not know who you are.</div>
  `);
  setW(`
    <div class="pkt out">${trunc(S.credHash,6)}</div>
    <div class="pkt in">uid+salt</div>
  `);
  setS(`
    <div class="section"><div class="label">Received</div>
      <div class="hash">${trunc(S.credHash,20)}</div></div>
    <div class="section"><div class="label">Matched to</div>
      <div class="value">user_id: ${trunc(S.userId)}</div>
      <div class="value">user_salt: ${trunc(S.userSalt)}</div></div>
    <div class="callout">I mapped a hash to an internal ID. I do not know the username, the password, or who this person is.</div>
  `);
  setN('Your browser hashed your credentials locally. Only the hash crossed the wire. The server matched it to an internal ID and salt. <strong>Two wire exchanges. No password transmitted. No MFA needed</strong> — there\'s no password to protect.');
}

function renderBlindToken() {
  showPanels();
  setC(`
    <div class="section"><div class="label">Step 3: Derive site-specific token (client only)</div>
      <div class="comp"><span class="fn">SHA-256</span>(<span class="secret">${S.username}</span> + <span class="arg">"blind-db-demo"</span> + <span class="arg">${trunc(S.userId,6)}</span> + <span class="arg">${trunc(S.userSalt,6)}</span>)</div>
      <div class="comp">= <span class="res">${trunc(S.siteToken,20)}</span></div></div>
    <div class="section"><div class="label">Proof of Human score</div>
      <div class="value" style="font-size:18px;color:#ffa657">${S.pohScore}</div>
      <div class="note">Travels with the token. Sites see the score, not how it was computed.</div></div>
    <div class="callout good">The server does not know this computation happened. Your <span style="color:#3fb950;text-decoration:underline">username</span> is the secret ingredient it lacks. A different site name would produce a completely different, unlinkable token.</div>
  `);
  setW('<div class="wire-label" style="color:#484f58">nothing</div>');
  setS(`
    <div class="callout" style="margin-top:60px;text-align:center">
      <p style="font-size:16px;color:#484f58">...</p>
      <p style="margin-top:8px">I was not involved in this step.</p>
      <p>I do not know it happened.</p>
    </div>
  `);
  setN('Your browser derived a site-specific token using your <strong>username</strong> — which only you know — combined with the server\'s user_id and salt. This token identifies you on this site. A different site produces a different, unlinkable token. <strong>Nothing crossed the wire. The server doesn\'t know this happened.</strong>');
}

function renderBlindWrite() {
  showPanels();
  setC(`
    <div class="section"><div class="label">Write a message to store</div>
      <textarea id="input-msg" placeholder="Type anything..."></textarea></div>
    <div class="section"><div class="label">What will happen</div>
      <div class="note">1. Derive a storage address from your credentials + "messages"</div>
      <div class="note">2. Derive an encryption key from your credentials + the address</div>
      <div class="note">3. Encrypt the message in your browser</div>
      <div class="note">4. Send the address + encrypted blob to the server</div></div>
  `);
  setW('');
  setS(`<div class="callout" style="margin-top:40px">Waiting. I will receive an opaque address and an opaque blob. I will store them without knowing what either one means.</div>`);
  setN('Type a message. It will be encrypted in your browser before the server ever sees it. The server will store it without knowing what it is, who wrote it, or what it\'s for.');
}

function renderBlindStored() {
  showPanels();
  setC(`
    <div class="section"><div class="label">Your message</div><div class="value">${S.userMsg}</div></div>
    <div class="section"><div class="label">Derive storage address</div>
      <div class="comp"><span class="fn">SHA-256</span>(<span class="secret">master_secret</span> + <span class="arg">"messages"</span> + <span class="arg">"0"</span>)</div>
      <div class="comp">= <span class="res">${trunc(S.recordId,20)}</span></div></div>
    <div class="section"><div class="label">Derive encryption key</div>
      <div class="comp"><span class="fn">SHA-256</span>(<span class="secret">master_secret</span> + <span class="arg">record_id</span> + <span class="arg">"encrypt"</span>)</div>
      <div class="comp">= <span class="res">${trunc(S.encKey,20)}</span></div></div>
    <div class="section"><div class="label">Encrypted</div>
      <div class="hash" style="font-size:11px">${trunc(S.encMsg,28)}</div></div>
  `);
  setW(`
    <div class="pkt out">${trunc(S.recordId,6)}</div>
    <div class="pkt out">${trunc(S.encMsg,6)}</div>
  `);
  setS(`
    <div class="section"><div class="label">Stored</div>
      <div class="value">Address: <span class="hash">${trunc(S.recordId,16)}</span></div>
      <div class="value">Blob: <span class="hash" style="font-size:11px">${trunc(S.encMsg,20)}</span></div></div>
    <div class="callout">Record stored. I do not know what this is. I do not know who stored it. The address is unrelated to the login hash. I cannot connect them.</div>
  `);
  setN('Your message was encrypted locally. The server received an opaque address and an opaque blob. <strong>The storage address is unrelated to your login hash and your site token</strong> — three strings from the same user, all unlinkable.');
}

function renderBlindRetrieve() {
  showPanels();
  const decrypted = xorDecrypt(S.encMsg, S.encKey);
  setC(`
    <div class="section"><div class="label">Re-derive the same address</div>
      <div class="comp"><span class="fn">SHA-256</span>(<span class="secret">master_secret</span> + <span class="arg">"messages"</span> + <span class="arg">"0"</span>)</div>
      <div class="comp">= <span class="res">${trunc(S.recordId,20)}</span> <span style="color:#3fb950">(same inputs = same output)</span></div></div>
    <div class="section"><div class="label">Received encrypted blob</div>
      <div class="hash" style="font-size:11px">${trunc(S.encMsg,28)}</div></div>
    <div class="section"><div class="label">Decrypted locally</div>
      <div class="value" style="color:#3fb950;font-size:15px">${decrypted}</div></div>
    <div class="three-hashes">
      <div class="hash-card"><div class="label">Login Hash</div><div class="hash">${trunc(S.credHash,10)}</div><div class="sub">Server saw this</div></div>
      <div class="hash-card"><div class="label">Site Token</div><div class="hash">${trunc(S.siteToken,10)}</div><div class="sub">Server never saw this</div></div>
      <div class="hash-card"><div class="label">Record Address</div><div class="hash">${trunc(S.recordId,10)}</div><div class="sub">Server stored this</div></div>
    </div>
    <div class="note" style="text-align:center;margin-top:8px">Same person. Three unrelated strings. The server cannot connect them.</div>
  `);
  setW(`
    <div class="pkt out">${trunc(S.recordId,6)}</div>
    <div class="pkt in">${trunc(S.encMsg,6)}</div>
  `);
  setS(`
    <div class="section"><div class="label">Request received</div>
      <div class="value">Address: <span class="hash">${trunc(S.recordId,16)}</span></div></div>
    <div class="section"><div class="label">Returned blob</div>
      <div class="hash" style="font-size:11px">${trunc(S.encMsg,20)}</div></div>
    <div class="callout">Someone asked for a record. I returned it. I do not know what it contains or who asked.</div>
  `);
  setN('Your browser re-derived the same address — <strong>deterministic: same inputs always produce the same output</strong> — retrieved the encrypted blob, and decrypted it locally. The server delivered data it could not read to a user it could not identify.');
}

function renderBlindBreach() {
  showFull(`
    <div class="breach-prompt">&gt; SELECT * FROM records;</div>
    <table class="db-table"><thead><tr><th>record_id</th><th>encrypted_value</th></tr></thead>
    <tbody>${blindDB.map(r=>`<tr><td class="hex">${trunc(r.id,24)}</td><td class="hex">${trunc(r.val,32)}</td></tr>`).join('')}</tbody></table>
    <div class="breach-count">${blindDB.length} records. No usernames. No emails. No messages. No browsing history.<br>
    Hex addresses pointing to encrypted blobs. <span class="safe-text">Your record is in here. The attacker cannot find it. Neither can the server.</span></div>
  `);
  setN('Same vulnerability. Same SQL injection. Same complete database access. <strong>But every record is a hex address pointing to an encrypted blob.</strong> No names, no emails, no messages, no browsing history. The attacker has everything the server has. The server has nothing useful.');
}

function renderInspector() {
  showFull(`
    <div style="text-align:center;margin-bottom:16px">
      <h3 style="color:#f0f6fc;font-size:18px">The server's complete database</h3>
      <p style="color:#8b949e;font-size:13px;margin-top:4px">Your data is in here. Can you find it?</p>
      <p style="color:#484f58;font-size:12px">The server can't either. Neither can a subpoena.</p>
    </div>
    <div style="margin-bottom:12px">
      <input type="text" id="search-db" placeholder="Search for your username..." oninput="filterDB()" style="max-width:400px;margin:0 auto;display:block" />
    </div>
    <table class="db-table" id="inspector-table"><thead><tr><th>#</th><th>record_id</th><th>encrypted_value</th></tr></thead>
    <tbody>${blindDB.map((r,i)=>`<tr><td style="color:#484f58">${i+1}</td><td class="hex">${trunc(r.id,28)}</td><td class="hex">${trunc(r.val,36)}</td></tr>`).join('')}</tbody></table>
    <div id="search-result" class="callout good" style="margin-top:16px;text-align:center;display:none"></div>
  `);
  setN('This is everything the server has. Every record for every user. <strong>Hashes that cannot be reversed. Encrypted blobs that cannot be read.</strong> Even with root on every server, every backup tape, every replica — this is all you get.');
}

function filterDB() {
  const q = $('search-db').value.toLowerCase();
  const res = $('search-result');
  if (!q) { res.style.display='none'; return; }
  res.style.display='block';
  // Search through all record IDs and values - nothing will match a username
  const found = blindDB.some(r => r.id.includes(q) || r.val.includes(q));
  if (found && q.length >= 6 && /^[0-9a-f]+$/.test(q)) {
    res.innerHTML = 'You found a hex substring match. But you don\'t know what it contains, who stored it, or what it\'s for.';
    res.className = 'callout warn';
  } else {
    res.innerHTML = `No records match "<strong>${q}</strong>". Usernames don't exist in this database. There is nothing to search.`;
    res.className = 'callout good';
  }
}

// ========== INIT ==========
function init() { seedDB(); steps[0].render(); updateUI(); }
window.onload = init;
</script>
</body>
</html>
